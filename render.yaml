services:
  # Gateway (Node runtime)
  - type: web
    name: gateway
    runtime: node
    plan: free
    rootDir: gateway
    buildCommand: npm ci
    startCommand: npm start
    envVars:
      - key: NODE_VERSION
        value: "22.16.0"
      # Pass host:port for each subgraph (internal DNS)
      - key: PRODUCTS_HOSTPORT
        fromService: { type: pserv, name: products, property: hostport }
      - key: USERS_HOSTPORT
        fromService: { type: pserv, name: users, property: hostport }
      - key: ORDERS_HOSTPORT
        fromService: { type: pserv, name: orders, property: hostport }

  # Products (Go, private)
  - type: pserv
    name: products
    runtime: docker
    dockerfilePath: ./services/products/dockerfile
    dockerContext: ./services/products
    plan: starter
    envVars:
      - key: PORT
        value: "4001"
      # Use the DB connection string Render exposes
      - key: DATABASE_URL
        fromDatabase: { name: products-db, property: connectionString }

  # Users (Go, private)
  - type: pserv
    name: users
    runtime: docker
    dockerfilePath: ./services/users/dockerfile
    dockerContext: ./services/users
    plan: starter
    envVars:
      - key: PORT
        value: "4002"
      - key: DATABASE_URL
        fromDatabase: { name: products-db, property: connectionString }

  # Orders (Go, private)
  - type: pserv
    name: orders
    runtime: docker
    dockerfilePath: ./services/orders/dockerfile
    dockerContext: ./services/orders
    plan: starter
    envVars:
      - key: PORT
        value: "4003"
      - key: DATABASE_URL
        fromDatabase: { name: products-db, property: connectionString }

  # Optional: Gradio UI (public)
  - type: web
    name: gradio-ui
    runtime: docker
    dockerfilePath: ./gradio_ui/dockerfile
    plan: free

databases:
  - name: products-db
    plan: free
